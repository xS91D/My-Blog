<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>文章列表 | xS91D</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.1/css/mdui.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.1/js/mdui.min.js"></script>
    
    <script src="https://unpkg.com/@portabletext/to-html@2.0.11/dist/to-html.umd.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <style>
        /* 您的 CSS 樣式維持不變 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        html, body { font-family: 'Noto Sans TC', sans-serif; height: 100%; overflow: hidden; background-color: #f5f5f5; }
        .main-container { display: flex; height: 100vh; }
        .left-panel { width: 300px; height: 100%; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px; box-sizing: border-box; text-align: center; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid rgba(255, 255, 255, 0.2); margin-bottom: 15px; }
        .profile-name { font-size: 1.8em; font-weight: bold; margin: 0; }
        .profile-tagline { color: rgba(255, 255, 255, 0.7); font-size: 0.9em; }
        .left-panel .mdui-list-item-content { justify-content: center; }
        .social-links .mdui-btn { margin: 0 5px; }
        .right-panel { margin-left: 300px; width: calc(100% - 300px); height: 100%; overflow-y: auto; padding: 40px; box-sizing: border-box; }
        .content-card { margin-bottom: 30px; }
        .article-card-media img { height: 200px; object-fit: cover; }
        .dialog-post-content { max-height: 70vh; overflow-y: auto; padding-top: 16px; }
        .dialog-post-content img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 1em; }

        @media (max-width: 768px) {
          body { overflow: auto; }
          .main-container { flex-direction: column; height: auto; }
          .left-panel { position: relative; width: 100%; height: auto; padding: 30px 15px; }
          .right-panel { margin-left: 0; width: 100%; height: auto; padding: 20px; }
        }
    </style>
</head>
 
<body class="mdui-theme-primary-grey mdui-theme-accent-blue">

    <div class="main-container">
        <aside class="left-panel mdui-color-grey-900 mdui-theme-layout-dark">
              <div>
                  <img src="image/about.jpg" alt="個人頭像" class="profile-avatar">
                  <h1 class="profile-name mdui-text-color-white">xS91D</h1>
                  <p class="profile-tagline">想像力使我變得更加強大👿</p>
              </div>
              <nav><ul class="mdui-list">
                  <li class="mdui-list-item mdui-ripple"><a href="index.html" class="mdui-list-item-content"><i class="mdui-list-item-icon mdui-icon material-icons">home</i>首頁</a></li>
                  <li class="mdui-list-item mdui-ripple mdui-list-item-active"><a href="post.html" class="mdui-list-item-content"><i class="mdui-list-item-icon mdui-icon material-icons">article</i>文章列表</a></li>
                  <li class="mdui-list-item mdui-ripple"><a href="portfolio.html" class="mdui-list-item-content"><i class="mdui-list-item-icon mdui-icon material-icons">work</i>專案列表</a></li>
                  <li class="mdui-list-item mdui-ripple"><a href="about.html" class="mdui-list-item-content"><i class="mdui-list-item-icon mdui-icon material-icons">person</i>關於我</a></li>
                  <li class="mdui-list-item mdui-ripple"><a href="donate.html" class="mdui-list-item-content"><i class="mdui-list-item-icon mdui-icon material-icons">attach_money</i>支持我</a></li>
              </ul></nav>
              <div>
                  <div class="social-links">
                      <a href="https://github.com/xS91D" target="_blank" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="fa-brands fa-github"></i></a>
                      <a href="https://discordapp.com/users/522308152427937803/" target="_blank" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="fa-brands fa-discord"></i></a>
                      <a href="https://www.facebook.com/cheonje.851428" target="_blank" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="fa-brands fa-facebook"></i></a>
                  </div>
                  <p class="mdui-text-color-theme-disabled" style="font-size: 0.8em; margin-top: 20px;">Copyright &copy; <span id="current-year"></span> xS91D All rights reserved</p>
              </div>
        </aside>

        <main class="right-panel">
            <div class="mdui-card content-card">
                <div class="mdui-card-primary"><div class="mdui-card-primary-title">文章列表</div></div>
            </div>

            <template id="article-card-template">
                <div class="mdui-col">
                    <div class="mdui-card mdui-hoverable">
                        <div class="mdui-card-media article-card-media">
                            <img src="https://i.imgur.com/caN8z1z.png" alt="文章圖片">
                        </div>
                        <div class="mdui-card-primary">
                            <div class="mdui-card-primary-title">文章標題</div>
                            <div class="mdui-card-primary-subtitle">發布日期</div>
                        </div>
                        <div class="mdui-card-actions">
                            <button class="mdui-btn mdui-ripple mdui-btn-raised mdui-color-theme-accent">閱讀全文</button>
                        </div>
                    </div>
                </div>
            </template>
            <div id="article-list-container" class="mdui-grid-list mdui-row-xs-1 mdui-row-sm-2 mdui-row-lg-3">
                <div class="mdui-preloader mdui-center"></div>
            </div>
        </main>
    </div>

<script>
    // 使用 'load' 事件確保所有外部資源 (包括函式庫) 都已載入完成
    window.addEventListener('load', function() {
        
        document.getElementById('current-year').textContent = new Date().getFullYear();
        
        // 將變數宣告移到 load 事件內部，確保此時 window.PortableTextToHtml 肯定存在
        const portableTextToHtml = window.PortableTextToHtml;

        // ▼▼▼ 關鍵除錯碼 ▼▼▼
        // 在主控台印出 portableTextToHtml 的實際值
        console.log('PortableTextToHtml library object:', portableTextToHtml);
        // 如果此刻它仍然是 undefined，就立刻彈出提示
        if (typeof portableTextToHtml === 'undefined') {
            alert('偵錯提示：PortableTextToHtml 函式庫載入失敗或未定義！請打開 F12 開發者工具，檢查「主控台(Console)」是否有其他紅色錯誤訊息。');
        }
        // ▲▲▲ 關鍵除錯碼 ▲▲▲

        const SANITY_PROJECT_ID = '41rn0gbp'; 
        const SANITY_DATASET = 'production';
        const API_BASE_URL = `https://${SANITY_PROJECT_ID}.api.sanity.io/v2021-10-21/data/query/${SANITY_DATASET}`;
        const container = document.getElementById('article-list-container');

        async function fetchArticleList() {
            // ... 此處及以下的所有程式碼都維持原樣，不需變動 ...
            const template = document.getElementById('article-card-template');
            const listQuery = encodeURIComponent(`*[_type == "post"] | order(publishedAt desc) {title, "slug": slug.current, "imageUrl": mainImage.asset->url, publishedAt}`);
            const listApiUrl = `${API_BASE_URL}?query=${listQuery}`;
            
            try {
                const response = await fetch(listApiUrl);
                if (!response.ok) throw new Error('API 請求失敗');
                const { result } = await response.json();
                
                container.innerHTML = ''; 
                
                if (!result || result.length === 0) {
                    container.innerHTML = '<p>目前還沒有發布任何文章喔！</p>';
                    return;
                }

                const fragment = document.createDocumentFragment();

                result.forEach(post => {
                    const cardClone = template.content.cloneNode(true);
                    
                    cardClone.querySelector('.mdui-card-primary-title').textContent = post.title;
                    cardClone.querySelector('.mdui-card-primary-subtitle').textContent = new Date(post.publishedAt).toLocaleDateString();
                    cardClone.querySelector('.article-card-media img').src = post.imageUrl || 'https://i.imgur.com/caN8z1z.png';
                    
                    const readButton = cardClone.querySelector('.mdui-card-actions button');
                    readButton.addEventListener('click', () => {
                        showFullPost(readButton, post.slug);
                    });
                    
                    fragment.appendChild(cardClone);
                });

                container.appendChild(fragment);

            } catch (error) {
                console.error('獲取文章列表失敗:', error);
                container.innerHTML = '<p class="mdui-text-color-red">讀取文章列表失敗，請檢查網路或 CORS 設定。</p>';
            }
        }

        async function showFullPost(buttonElement, slug) {
            if (!slug || typeof portableTextToHtml === 'undefined') {
                mdui.alert('頁面關鍵元件載入失敗，這是一個意料之外的錯誤。', '錯誤');
                return;
            }

            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<div class="mdui-spinner mdui-spinner-colorful" style="width: 24px; height: 24px;"></div>';
            buttonElement.disabled = true;

            const postQuery = encodeURIComponent(`*[_type == "post" && slug.current == "${slug}"][0]{title, body, publishedAt, "authorName": author->name}`);
            const postApiUrl = `${API_BASE_URL}?query=${postQuery}`;

            try {
                const response = await fetch(postApiUrl);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.description || 'API 請求失敗');
                }
                const { result } = await response.json();
                if (!result) throw new Error('在資料庫中找不到該篇文章 (slug: ' + slug + ')');

                const contentHtml = result.body ? portableTextToHtml.toHtml(result.body) : '<p>沒有內文。</p>';
                
                const postHtml = `
                    <div class="mdui-typo dialog-post-content">
                        <p class="mdui-text-color-theme-secondary">由 ${result.authorName || '匿名作者'} 發布於 ${new Date(result.publishedAt).toLocaleDateString()}</p>
                        <div class="mdui-divider"></div>
                        ${contentHtml}
                    </div>`;
                
                mdui.dialog({
                    title: result.title,
                    content: postHtml,
                    history: false,
                    buttons: [{ text: '關閉' }]
                });

            } catch(error) {
                console.error('獲取文章全文失敗:', error);
                mdui.dialog({
                    title: '讀取失敗',
                    content: `<p class="mdui-text-color-red">抱歉，讀取文章時發生錯誤。</p><pre style="background-color:#eee;padding:8px;border-radius:4px;font-size:12px;white-space:pre-wrap;word-break:break-all;">${error.message}</pre>`,
                    buttons: [{ text: '關閉' }]
                });
            } finally {
                buttonElement.innerHTML = originalButtonText;
                buttonElement.disabled = false;
            }
        }

        // 啟動主程式
        fetchArticleList();
    });
</script>
</body>

</html>
